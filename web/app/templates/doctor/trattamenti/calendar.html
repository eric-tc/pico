{% extends "base.html" %}

{% block content %}

<div id='calendar'></div>


<script>

    // Funzione per determinare l'URL di reindirizzamento in base alla data dell'evento
    function getEventRedirectUrl(info,) {
        
        var currentDate = new Date();
        var daysBefore = new Date(currentDate);
        daysBefore.setDate(currentDate.getDate() - parseInt("{{days_before}}",10));
        var daysAfter = new Date(currentDate);
        daysAfter.setDate(currentDate.getDate() + parseInt("{{days_after}}",10));
        
        if(info.event.extendedProps.closed=="2"){
            return { url: '/next_controls/' + info.event.id + "/2", code: 2 };
        }
        var eventDate = new Date(info.event.start);
        if (eventDate >= daysBefore && eventDate <= daysAfter) {
            return { url: '/next_controls/' + info.event.id + "/1", code: 1 };
        } else if (eventDate < currentDate) {
            return { url: '/next_controls/' + info.event.id + "/2", code: 2 };
        } else if (eventDate > currentDate) {
            return { url: '/next_controls/' + info.event.id + "/0", code: 0 };
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            events: '/treatments_events',
            initialView: 'dayGridMonth',
            headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            dateClick: function(info){
                
                
                //window.location.href = '/controls_for_day/'+info.dateStr;

            
            }, //Endpoit per recuperare gli eventi da mostrare nel calendario
            eventClick:function(info){
                
                var redirectUrl = getEventRedirectUrl(info);
                if (redirectUrl) {
                    window.location.href = redirectUrl.url;
                }
            },
            locale: 'it', // Fetch events from Flask endpoint
            height: 'auto',
            eventDidMount: function(info) {

                // Attach a tooltip to show full event title on hover
                $(info.el).tooltip({
                    title: info.event.title,
                    placement: 'top',
                    trigger: 'hover',
                    container: 'body'
                });
            }
        });
        calendar.render();
        
        // Add event listener for mousewheel to scroll through months
        calendarEl.addEventListener('wheel', function(event) {
            if (event.deltaY < 0) {
                calendar.prev(); // Scroll up to go to the previous month
            } else if (event.deltaY > 0) {
                calendar.next(); // Scroll down to go to the next month
            }
            event.preventDefault(); // Prevent the default scroll behavior
        });
    });
</script>

{% endblock %}

