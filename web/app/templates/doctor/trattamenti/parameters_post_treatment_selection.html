
{% extends "base.html" %}

{% block content %}


<div class="row">
  <div class="col-md-12 mb-12 col-lg-12">

    {% include 'general/pathology_form_post.html' %}
  
  </div>
</div>




<script>


  function retrieve_form_data() {
    // 1. Creiamo il clone
    var formClone = $("#form-post-treatment").clone();

    // 2. Aggiorniamo il clone con i valori REALI presi dall'interfaccia utente
    formClone.find("input, textarea, select").each(function () {
        
        // Recuperiamo l'ID per trovare l'elemento ORIGINALE corrispondente
        var inputId = $(this).attr("id");
        
        // Se l'elemento non ha ID, non possiamo trovare l'originale in modo sicuro con questa logica
        if (!inputId) return; 

        // Riferimento all'elemento originale nel DOM (quello che l'utente vede)
        var originalElement = $("#" + inputId);
        // Valore attuale inserito dall'utente
        var realValue = originalElement.val(); 

        if ($(this).is(":checkbox") || $(this).is(":radio")) {
            // CHECKBOX & RADIO
            // Leggiamo la proprietà .prop("checked") dall'originale
            if (originalElement.prop("checked")) {
                $(this).attr("checked", "checked"); // Importante usare "checked" stringa per HTML standard
            } else {
                $(this).removeAttr("checked");
            }

        } else if ($(this).is("select")) {
            // SELECT
            // Cicla su tutte le opzioni del CLONE
            $(this).find("option").each(function () {
                // Confronta il valore dell'opzione con il valore reale della select originale
                if ($(this).val() == realValue) {
                    $(this).attr("selected", "selected");
                } else {
                    $(this).removeAttr("selected");
                }
            });

        } else if ($(this).is("textarea")) {
           
            var replacementDiv = $("<div></div>");

            // 2. Copiamo lo stile base per farlo sembrare simile al form (opzionale)
            // 'white-space: pre-wrap' è FONDAMENTALE: mantiene gli "a capo" e gli spazi scritti dall'utente
            replacementDiv.css({
                "width": "100%",
                "min-height": $(this).height() + "px", // Mantiene almeno l'altezza originale
                "white-space": "pre-wrap",             // Mantiene la formattazione del testo (a capo)
                "font-family": $(this).css("font-family"),
                "font-size": $(this).css("font-size"),
                "border": "1px solid #ccc",            // Bordo simile agli input (opzionale)
                "padding": "6px 12px",                 // Padding stile Bootstrap
                "color": "black"
            });

            // 3. Inseriamo il testo REALE preso dall'elemento originale
            replacementDiv.text(realValue);

            // 4. Sostituiamo la textarea NEL CLONE con questo div
            $(this).replaceWith(replacementDiv);

        } else {
            // INPUT DI TESTO, DATE, EMAIL, HIDDEN, ecc.
            // Qui va bene usare l'attributo value
            $(this).attr("value", realValue);
        }
    });

    return formClone;
  }

  function generate_full_pdf(){
    
    
    var formClone = retrieve_form_data();
        // Get the updated form HTML
    var formHtml = formClone.prop("outerHTML");
        
    // Send the HTML to the server
    $.ajax({
        url: "/generate_page_pdf/{{row_id}}",
        method: "POST",
        headers: {
          "X-CSRFToken": $("input[name=csrf_token]").val(), // Add CSRF token in headers
        },
        contentType: "application/json",
        data: JSON.stringify({ html: formHtml }),
        success: function (response) {
            // Redirect to the PDF download link
            window.location.href =  "/static/pdf_files/"+ response.filename;
        },
        error: function (xhr, status, error) {
            console.error("Error:", error);
        }
    });

  }

  $(document).ready(function () {
    $("#generate-full-pdf").click(function () {
        // Get the HTML content of the current page
        generate_full_pdf();
    });
});

document.getElementById("form-post-treatment").addEventListener("submit", function (e) {
  
  var formClone = retrieve_form_data();
  var formHtml = formClone.prop("outerHTML");
        
  // Assign serialized data to the hidden input field
  document.getElementById("hidden_html").value = JSON.stringify({ html: formHtml });
});

 
</script>

<script>
    // Pass Jinja variable to JavaScript

    const week_to_add= "{{ week_to_add }}";
    console.log(week_to_add);
    
    //La Data intervento deve essere quella originaria intervento
    DataIntervento = new Date("{{data_intervento}}");


</script>

<script src="{{ url_for('static', filename='js/datepicker_only_week.js') }}"></script>

<script>
  // Write a date to the input field
  var dateInput = document.getElementById('datepicker');
  
  // Example: Set the input date to today's date
  var date = new Date("{{data_controllo}}");
  //convert date to DD--MM-YYYY

  var day = String(date.getDate()).padStart(2, '0'); // Pad day with leading zero if necessary
  var month = String(date.getMonth() + 1).padStart(2, '0'); // Months are zero-based, so add 1
  var year = date.getFullYear();

// Format the date as dd-mm-yyyy
var formattedDate = day + '-' + month + '-' + year;

dateInput.value = formattedDate;
</script>


{% endblock %}
